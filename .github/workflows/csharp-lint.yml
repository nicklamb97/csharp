name: C# File Linting on Main

on:
  push:
    branches:
      - main
    paths:
      - '**.cs'

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 2  # To be able to get the changed files
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'  # Adjust this to your .NET version if needed
    
    - name: Install dotnet-format
      run: dotnet tool install -g dotnet-format
    
    - name: Get changed files
      id: changed-files
      run: |
        changed_files=$(git diff --name-only HEAD^ HEAD | grep '\.cs$' || true)
        if [ -z "$changed_files" ]; then
          echo "No .cs files changed"
          exit 0
        fi
        echo "files=$changed_files" >> $GITHUB_OUTPUT
    
    - name: Run dotnet format
      if: steps.changed-files.outputs.files
      run: |
        for file in ${{ steps.changed-files.outputs.files }}; do
          dotnet format "$file" --verify-no-changes --verbosity detailed
        done
    
    - name: Install and run StyleCop
      if: steps.changed-files.outputs.files
      run: |
        dotnet new console -n TempProject
        cd TempProject
        dotnet add package StyleCop.Analyzers
        for file in ${{ steps.changed-files.outputs.files }}; do
          cp "../$file" .
        done
        dotnet build /p:TreatWarningsAsErrors=true
